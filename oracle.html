<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Oracle Materials ‚Äì Enhanced Search</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --brand-bg: #1e4672;
      --brand-dark: #163857;
      --accent: #b42c30;
      --text: #172b4d;
      --muted: #6b778c;
      --border: #dde5ef;
      --table-header: #5a2a7a;
      --table-header-text: #ffffff;
      --row-alt: #f8fafc;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background: #f4f6f9;
    }
    .topbar {
      background: var(--brand-bg);
      color: #fff;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .brand-mark {
      width: 36px; height: 36px; border-radius: 6px;
      background: linear-gradient(135deg, var(--accent), #f56c6f);
      box-shadow: 0 1px 2px rgba(0,0,0,0.15);
    }
    .brand-text {
      display: grid;
      line-height: 1.2;
    }
    .brand-text .title { font-weight: 700; letter-spacing: 0.2px; color: #000 !important; }
    .brand-text .subtitle { opacity: 0.9; font-size: 13px; }
    .lang-switch { display: inline-flex; gap: 8px; align-items: center; }
    .btn.small { height: 28px; padding: 0 10px; font-size: 12px; min-width: auto; }

    .controls {
      background: #fff;
      margin: 16px 20px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      box-shadow: 0 1px 2px rgba(16, 24, 40, 0.06);
    }
    .inputs {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }
    .field { display: grid; gap: 6px; }
    .label { font-size: 12px; color: var(--muted); display: flex; justify-content: space-between; }
    .label span.ar { direction: rtl; }
    .text-input {
      height: 36px; border: 1px solid var(--border); border-radius: 8px;
      padding: 8px 10px; outline: none; background: #fff; color: #000 !important;
    }
    .text-input::placeholder { color: #000; opacity: 1; }
    .actions {
      display: flex; align-items: center; justify-content: space-between; margin-top: 12px;
    }
    .left-actions { display: flex; gap: 8px; align-items: center; }
    .btn {
      height: 36px; padding: 0 14px; border: 1px solid var(--border);
      border-radius: 8px; background: #fff; color: var(--text);
      display: inline-flex; align-items: center; gap: 8px; cursor: pointer; text-decoration: none;
    }
    .btn.primary { background: var(--brand-bg); color: #fff; border-color: var(--brand-dark); }
    .back-link { background: #2563eb; color: #fff; border-color: #1d4ed8; }
    .btn.success { background: #28a745; border-color: #1e7e34; color: #fff; }
    .counter { font-size: 13px; color: var(--muted); }
    .loader { display: none; align-items: center; gap: 8px; color: var(--muted); }
    .spinner { width: 18px; height: 18px; border: 3px solid #d1d5db; border-top-color: var(--brand-bg); border-radius: 50%; animation: spin 0.9s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .table-wrap {
      background: #fff; margin: 12px 20px; border: 1px solid var(--border);
      border-radius: 10px; overflow: hidden; box-shadow: 0 1px 2px rgba(16, 24, 40, 0.06);
    }
    table { width: 100%; border-collapse: collapse; }
    thead th {
      background: var(--table-header); color: var(--table-header-text);
      text-align: left; font-weight: 600; padding: 10px; font-size: 12px;
      position: sticky; top: 0; z-index: 2;
    }
    tbody td { border-top: 1px solid var(--border); padding: 9px; font-size: 13px; vertical-align: top; }
    tbody tr:nth-child(even) { background: var(--row-alt); }
    .code { font-variant-numeric: tabular-nums; }
    .unit, .qty, .type { white-space: nowrap; }

    /* Responsive layout tweaks */
    @media (max-width: 980px){
      .inputs { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 640px){
      .topbar { flex-wrap: wrap; }
      .inputs { grid-template-columns: 1fr; }
      .actions { flex-direction: column; align-items: stretch; gap: 8px; }
      .left-actions { flex-wrap: wrap; }
      .btn { width: 100%; min-width: 0; }
    }
    .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    table { min-width: 720px; }

    .footer { color: var(--muted); font-size: 12px; padding: 10px 20px; }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="brand-mark" aria-hidden="true"></div>
      <div class="brand-text">
        <div class="title" data-i18n="page_title_en">Oracle Materials</div>
        <div class="subtitle" data-i18n="page_sub_en">Enhanced Search</div>
      </div>
    </div>
    <div class="brand-text" style="text-align:right">
      <div class="title" data-i18n="brand_title">ÿ¥ÿ±ŸÉÿ© ÿßŸÑÿÆŸÑŸäÿ¨ ŸÑŸÑÿÆÿØŸÖÿßÿ™ ÿßŸÑÿµŸÜÿßÿπŸäÿ©</div>
      <div class="subtitle">GISCO</div>
    </div>
    <div class="lang-switch" aria-label="Language Switch">
      <button class="btn small" data-lang="ar">ÿπÿ±ÿ®Ÿä</button>
      <button class="btn small" data-lang="en">English</button>
    </div>
  </header>
  <div style="margin: 10px 20px;">
    <a class="btn back-link" href="index.html" data-i18n="back_main" title="Back to Main Page">Back to Main Page</a>
  </div>

  <section class="controls">
    <div class="inputs">
      <label class="field">
        <div class="label"><span>First Text</span><span class="ar">ÿßŸÑŸÜÿµ ÿßŸÑÿ£ŸàŸÑ</span></div>
        <input id="q1" class="text-input" type="text" placeholder="Type to search‚Ä¶" />
      </label>
      <label class="field">
        <div class="label"><span>Second Text</span><span class="ar">ÿßŸÑŸÜÿµ ÿßŸÑÿ´ÿßŸÜŸä</span></div>
        <input id="q2" class="text-input" type="text" placeholder="Type to search‚Ä¶" />
      </label>
      <label class="field">
        <div class="label"><span>3rd Text</span><span class="ar">ÿßŸÑŸÜÿµ ÿßŸÑÿ´ÿßŸÑÿ´</span></div>
        <input id="q3" class="text-input" type="text" placeholder="Type to search‚Ä¶" />
      </label>
      <label class="field">
        <div class="label"><span>4th Text</span><span class="ar">ÿßŸÑŸÜÿµ ÿßŸÑÿ±ÿßÿ®ÿπ</span></div>
        <input id="q4" class="text-input" type="text" placeholder="Type to search‚Ä¶" />
      </label>
    </div>
    <div class="actions">
      <div class="left-actions">
        <button id="btnPreview" class="btn primary" title="Preview results"><span>üîé</span>Preview</button>
        <button id="btnPrint" class="btn" title="Print current results"><span>üñ®Ô∏è</span>Print</button>
        <input type="file" id="localFile" accept=".xlsx,.xls" style="display:none" />
        <button id="btnLocal" class="btn success" title="Load local Excel" onclick="document.getElementById('localFile').click()">Load Excel</button>
        <input type="text" id="pathSelector" placeholder="Selected file path" readonly style="height:36px;border:1px solid var(--border);border-radius:8px;padding:0 10px;min-width:220px;" />
      </div>
      <div class="counter"><span id="resultCount">0</span> <span data-i18n="results_label">results</span></div>
    </div>
    <div id="statusBar" style="margin-top:8px; font-size:13px; color: var(--muted);"></div>
    <div id="loader" class="loader" aria-live="polite" style="margin: 6px 20px 0;">
      <div class="spinner" aria-hidden="true"></div>
      <span>Loading data‚Ä¶</span>
    </div>
  </section>

  <section class="table-wrap">
    <table id="dataTable">
      <thead>
        <tr>
          <th>ORACLE CODE</th>
          <th>ITEM DESCRIPTION</th>
          <th>UNIT</th>
          <th>QTY</th>
          <th>TYPE</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </section>

  <div class="footer">Note: searchIndex is internal and excluded from exports.</div>

  <script>
    // i18n setup
    const I18N = {
      en: {
        brand_title: 'Gulf Industrial Service Company',
        back_main: 'Back to Main Page',
        results_label: 'results',
        page_title_en: 'Oracle Materials',
        page_sub_en: 'Enhanced Search'
      },
      ar: {
        brand_title: 'ÿ¥ÿ±ŸÉÿ© ÿßŸÑÿÆŸÑŸäÿ¨ ŸÑŸÑÿÆÿØŸÖÿßÿ™ ÿßŸÑÿµŸÜÿßÿπŸäÿ©',
        back_main: 'ÿßŸÑÿπŸàÿØÿ© ÿ•ŸÑŸâ ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©',
        results_label: 'ŸÜÿ™ÿßÿ¶ÿ¨',
        page_title_en: 'ŸÖŸàÿßÿØ ÿßŸÑÿßŸàÿ±ÿßŸÉŸÑ',
        page_sub_en: 'ÿ®ÿ≠ÿ´ ŸÖÿ≠ÿ≥ŸëŸÜ'
      }
    };

    const getLang = () => localStorage.getItem('lang') || 'ar';
    const applyLang = (lang) => {
      document.documentElement.setAttribute('dir', lang === 'ar' ? 'rtl' : 'ltr');
      const dict = I18N[lang] || I18N.ar;
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (dict[key]) el.textContent = dict[key];
      });
    };
    const setLang = (lang) => { localStorage.setItem('lang', lang); applyLang(lang); };
    document.addEventListener('DOMContentLoaded', () => {
      applyLang(getLang());
      document.querySelectorAll('[data-lang]').forEach(btn => btn.addEventListener('click', () => setLang(btn.dataset.lang)));
    });

    const excelPath = 'Oracle.xlsx';
    const DATA_VERSION = '1';
    const CACHE_KEY = excelPath + '|v' + DATA_VERSION;
    let ALL_ROWS = [];
    let SEARCH_INDEX = [];

    // Flexible field mapping
    const FIELD_ALIASES = {
      code: ['oracle code','oracle_code','code','item code','item_code','itemid','id'],
      description: ['item description','description','desc','item name','name'],
      unit: ['unit','uom','measure','unit of measure'],
      qty: ['qty','quantity','onhand','on hand','stock','balance'],
      type: ['type','category','class']
    };

    function normalizeKey(k){
      return String(k || '').toLowerCase().replace(/\s+|_/g,'').trim();
    }

    function pickField(obj, aliases){
      const keys = Object.keys(obj);
      const normToKey = new Map(keys.map(k => [normalizeKey(k), k]));
      for (const alias of aliases){
        const nk = normalizeKey(alias);
        if (normToKey.has(nk)) return obj[normToKey.get(nk)];
      }
      for (const k of keys){
        const v = obj[k];
        if (v !== undefined && v !== null && String(v).trim() !== '') return v;
      }
      return '';
    }

    function buildRow(item){
      const code = String(pickField(item, FIELD_ALIASES.code) || '').trim();
      const description = String(pickField(item, FIELD_ALIASES.description) || '').trim();
      const unit = String(pickField(item, FIELD_ALIASES.unit) || '').trim();
      const qty = String(pickField(item, FIELD_ALIASES.qty) || '').trim();
      const type = String(pickField(item, FIELD_ALIASES.type) || '').trim();

      const searchIndex = [code, description, unit, qty, type]
        .map(s => String(s).toLowerCase())
        .join(' | ');

      return { code, description, unit, qty, type, searchIndex };
    }

    function renderTable(rows){
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';
      for (let i = 0; i < rows.length; i++){
        const r = rows[i];
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="code">${escapeHtml(r.code)}</td>
          <td>${escapeHtml(r.description)}</td>
          <td class="unit">${escapeHtml(r.unit)}</td>
          <td class="qty">${escapeHtml(r.qty)}</td>
          <td class="type">${escapeHtml(r.type)}</td>
        `;
        tr.dataset.rowIndex = String(i);
        tbody.appendChild(tr);
      }
      updateCounter(rows.length);
    }

    function updateCounter(n){
      document.getElementById('resultCount').textContent = String(n);
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','<')
        .replaceAll('>','>')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#39;');
    }

    // Debounced search
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, 150);
      };
    }

    // Fast filtering
    function filterNow(){
      const q1 = document.getElementById('q1').value.trim().toLowerCase();
      const q2 = document.getElementById('q2').value.trim().toLowerCase();
      const q3 = document.getElementById('q3').value.trim().toLowerCase();
      const q4 = document.getElementById('q4').value.trim().toLowerCase();

      const queries = [q1,q2,q3,q4].filter(Boolean);

      if (queries.length === 0){
        const tbody = document.getElementById('tableBody');
        Array.from(tbody.children).forEach(tr => tr.style.display = '');
        updateCounter(ALL_ROWS.length);
        return;
      }

      if (!SEARCH_INDEX.length && ALL_ROWS.length > 0) {
        SEARCH_INDEX = ALL_ROWS.map(row => row.searchIndex);
      }

      const matches = [];
      for (let i = 0; i < SEARCH_INDEX.length; i++) {
        const idx = SEARCH_INDEX[i];
        let match = true;
        for (const q of queries) {
          if (!idx.includes(q)) {
            match = false;
            break;
          }
        }
        if (match) matches.push(i);
      }

      const tbody = document.getElementById('tableBody');
      const rows = Array.from(tbody.children);
      let visible = 0;
      for (let i = 0; i < rows.length; i++) {
        rows[i].style.display = matches.includes(i) ? '' : 'none';
        if (matches.includes(i)) visible++;
      }
      updateCounter(visible);
    }

    const debouncedFilter = debounce(filterNow, 150);

    // IndexedDB cache
    function idbOpen(){
      return new Promise((resolve, reject) => {
        if (!('indexedDB' in window)) { resolve(null); return; }
        const req = indexedDB.open('excelCache', 1);
        req.onupgradeneeded = () => {
          const db = req.result;
          if (!db.objectStoreNames.contains('files')) db.createObjectStore('files');
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    async function idbGet(key){
      try {
        const db = await idbOpen();
        if (!db) return null;
        return await new Promise((resolve, reject) => {
          const tx = db.transaction('files','readonly');
          const store = tx.objectStore('files');
          const r = store.get(key);
          r.onsuccess = () => resolve(r.result || null);
          r.onerror = () => reject(r.error);
        });
      } catch { return null; }
    }

    async function idbSet(key, value){
      try {
        const db = await idbOpen();
        if (!db) return false;
        return await new Promise((resolve, reject) => {
          const tx = db.transaction('files','readwrite');
          const store = tx.objectStore('files');
          const r = store.put(value, key);
          r.onsuccess = () => resolve(true);
          r.onerror = () => reject(r.error);
        });
      } catch { return false; }
    }

    // Load Excel directly using SheetJS (no worker needed)
    async function loadExcel(){
      try {
        showLoader(true);
        setStatus('Checking cache‚Ä¶');

        const cached = await idbGet(CACHE_KEY);
        if (cached && Array.isArray(cached.rows) && cached.rows.length > 0){
          ALL_ROWS = cached.rows;
          SEARCH_INDEX = cached.rows.map(r => r.searchIndex);
          renderTable(ALL_ROWS);
          setStatus(`Loaded ${ALL_ROWS.length} rows from cache`);
          showLoader(false);
          setTimeout(() => revalidateExcel().catch(console.error), 2000);
          return;
        }

        // No cache ‚Üí fetch file
        setStatus('Fetching Oracle.xlsx‚Ä¶');
        const res = await fetch(excelPath + '?v=' + DATA_VERSION);
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);

        const arrayBuffer = await res.arrayBuffer();
        setStatus('Parsing Excel data‚Ä¶');

        // Parse with SheetJS ‚Äî robust handling
        const workbook = XLSX.read(arrayBuffer, { type: 'array', cellText: true, cellDates: true });

        // Get first worksheet
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];

        // Convert to JSON
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });

        if (!jsonData || jsonData.length === 0) {
          throw new Error('No data found in worksheet.');
        }

        // Extract headers (first row)
        const headers = jsonData[0].map(h => String(h || '').trim());
        const rows = [];

        // Process data rows (skip header)
        for (let i = 1; i < jsonData.length; i++) {
          const row = {};
          const dataRow = jsonData[i];
          for (let j = 0; j < headers.length && j < dataRow.length; j++) {
            const key = headers[j];
            const value = dataRow[j];
            row[key] = value === undefined ? '' : value;
          }
          if (Object.keys(row).length > 0) {
            rows.push(buildRow(row));
          }
        }

        if (rows.length === 0) {
          throw new Error('No valid rows parsed. Check if Excel has headers and data.');
        }

        ALL_ROWS = rows;
        SEARCH_INDEX = rows.map(r => r.searchIndex);
        renderTable(rows);
        setStatus(`Loaded ${rows.length} rows from Oracle.xlsx`);
        
        // Cache it
        idbSet(CACHE_KEY, { rows, ts: Date.now() }).catch(console.error);
        showLoader(false);

      } catch (err) {
        console.error('Excel load failed:', err);
        setStatus(`Failed to load Excel: ${err.message}`, true);
        const btn = document.getElementById('btnLocal');
        if (btn) btn.style.display = 'inline-flex';
        updateCounter(0);
        showLoader(false);
      }
    }

    async function revalidateExcel(){
      try {
        const res = await fetch(excelPath + '?v=' + DATA_VERSION);
        if (!res.ok) return;

        const arrayBuffer = await res.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array', cellText: true, cellDates: true });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });

        if (!jsonData || jsonData.length === 0) return;

        const headers = jsonData[0].map(h => String(h || '').trim());
        const rows = [];

        for (let i = 1; i < jsonData.length; i++) {
          const row = {};
          const dataRow = jsonData[i];
          for (let j = 0; j < headers.length && j < dataRow.length; j++) {
            const key = headers[j];
            const value = dataRow[j];
            row[key] = value === undefined ? '' : value;
          }
          if (Object.keys(row).length > 0) {
            rows.push(buildRow(row));
          }
        }

        if (rows.length !== ALL_ROWS.length) {
          ALL_ROWS = rows;
          SEARCH_INDEX = rows.map(r => r.searchIndex);
          renderTable(rows);
          setStatus(`Updated to ${rows.length} rows`);
        }

        idbSet(CACHE_KEY, { rows, ts: Date.now() }).catch(console.error);

      } catch (err) {
        console.error('Revalidation failed:', err);
      }
    }

    async function loadLocalFile(file){
      if (!file) return;

      const ps = document.getElementById('pathSelector');
      const input = document.getElementById('localFile');
      const fname = file.name.toLowerCase();

      if (fname !== 'oracle.xlsx'){
        setStatus('Please select the file named "Oracle.xlsx" only.', true);
        if (ps) { ps.value = ''; ps.style.display = 'none'; }
        if (input) input.value = '';
        return;
      }

      if (ps) { ps.style.display = 'inline-flex'; ps.value = file.name; }
      setStatus('Loading local Excel‚Ä¶');
      showLoader(true);

      try {
        const arrayBuffer = await file.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array', cellText: true, cellDates: true });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });

        if (!jsonData || jsonData.length === 0) throw new Error('No data found.');

        const headers = jsonData[0].map(h => String(h || '').trim());
        const rows = [];

        for (let i = 1; i < jsonData.length; i++) {
          const row = {};
          const dataRow = jsonData[i];
          for (let j = 0; j < headers.length && j < dataRow.length; j++) {
            const key = headers[j];
            const value = dataRow[j];
            row[key] = value === undefined ? '' : value;
          }
          if (Object.keys(row).length > 0) {
            rows.push(buildRow(row));
          }
        }

        if (rows.length === 0) throw new Error('No valid rows parsed.');

        ALL_ROWS = rows;
        SEARCH_INDEX = rows.map(r => r.searchIndex);
        renderTable(rows);
        setStatus(`Loaded ${rows.length} rows from local file`);
        idbSet(CACHE_KEY, { rows, ts: Date.now() }).catch(console.error);

      } catch (err) {
        console.error('Local load failed:', err);
        setStatus(`Local load failed: ${err.message}`, true);
      } finally {
        showLoader(false);
      }
    }

    function setStatus(msg, isError=false){
      const el = document.getElementById('statusBar');
      el.textContent = msg || '';
      el.style.color = isError ? '#b00020' : 'var(--muted)';
    }

    function showLoader(show){
      const el = document.getElementById('loader');
      if (el) el.style.display = show ? 'inline-flex' : 'none';
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
      const input = document.getElementById('localFile');
      if (input) input.addEventListener('change', (e) => loadLocalFile(e.target.files[0]));

      for (const id of ['q1','q2','q3','q4']){
        document.getElementById(id).addEventListener('input', debouncedFilter);
      }

      document.getElementById('btnPreview').addEventListener('click', filterNow);
      document.getElementById('btnPrint').addEventListener('click', () => window.print());

      // Auto-load on server, fallback to local on file://
      if (location.protocol === 'file:') {
        const btn = document.getElementById('btnLocal');
        const ps = document.getElementById('pathSelector');
        if (btn) btn.style.display = 'inline-flex';
        if (ps) ps.style.display = 'inline-flex';
        setStatus('Opened without server. Use "Load Local Excel" to select Oracle.xlsx');
      } else {
        loadExcel().catch(err => {
          console.error('Auto-load failed:', err);
          setStatus(`Error loading Oracle.xlsx: ${err.message}`, true);
          updateCounter(0);
        });
      }
    });
  </script>
</body>
</html>
